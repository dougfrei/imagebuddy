/**
 * ImageTools v0.2.2 | ISC
 * 
 */
;(function() {
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_slicedToArray=function(){function t(t,e){var n=[],i=!0,o=!1,a=void 0;try{for(var s,r=t[Symbol.iterator]();!(i=(s=r.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){o=!0,a=t}finally{try{!i&&r.return&&r.return()}finally{if(o)throw a}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();if("function"!=typeof Object.assign&&(Object.assign=function(t,e){if(null===t)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(t),i=1;i<arguments.length;i++){var o=arguments[i];if(null!==o)for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(n[a]=o[a])}return n}),"function"!=typeof window.CustomEvent){var _CustomEvent=function(t,e){var n=e||{bubbles:!1,cancelable:!1,detail:void 0},i=document.createEvent("CustomEvent");return i.initCustomEvent(t,n.bubbles,n.cancelable,n.detail),i};_CustomEvent.prototype=window.Event.prototype,window.CustomEvent=_CustomEvent}window.ImageTools=function(){function t(e){_classCallCheck(this,t),this.eventsRunning={},this.elementCache=[],this.events=[],this.config={events:{resize:"imageToolsResize",scroll:"imageToolsScroll"},attributes:{sources:"data-it-sources",lazyLoad:"data-it-lazyload",lazyLoadThreshold:"data-it-lazyload-threshold",matchDPR:"data-it-match-dpr",noHeight:"data-it-no-height"}},this.opts=Object.assign({debug:!1,matchDPR:!0,lazyLoad:!0,lazyLoadThreshold:100},e),this.setupEventListeners(),this.update()}return _createClass(t,[{key:"update",value:function(){this.getElements();for(var t=0;t<this.elementCache.length;t++){var e=this.elementCache[t];e.loaded||e.options.lazyLoad&&!1===this.canLazyLoad(e)||this.chooseImage(e)}}},{key:"canLazyLoad",value:function(t){return!(!t.options.lazyLoad||t.loaded)&&t.el.offsetTop-(window.pageYOffset+window.innerHeight)<=t.options.lazyLoadThreshold}},{key:"throttleEventListener",value:function(t,e){var n=this;this.eventsRunning.hasOwnProperty(t)||(this.eventsRunning[t]=!1),window.addEventListener(t,function(){n.eventsRunning[t]||(n.eventsRunning[t]=!0,requestAnimationFrame(function(){window.dispatchEvent(new CustomEvent(t+"-throttled")),n.eventsRunning[t]=!1}))}),"function"==typeof e&&window.addEventListener(t+"-throttled",e)}},{key:"setupEventListeners",value:function(){this.throttleEventListener("resize",this.resizeHandler.bind(this)),this.throttleEventListener("scroll",this.scrollHandler.bind(this))}},{key:"debug",value:function(){if(this.opts.debug){var t;(t=console).log.apply(t,arguments)}}},{key:"debugInfo",value:function(){if(this.opts.debug){var t;(t=console).info.apply(t,arguments)}}},{key:"debugTable",value:function(){if(this.opts.debug){var t;(t=console).table.apply(t,arguments)}}},{key:"getElements",value:function(){this.elementCache=[];for(var t=document.querySelectorAll("["+this.config.attributes.sources+"]"),e=0;e<t.length;e++){var n=t[e];this.elementCache.push({el:n,elType:n.tagName.toLowerCase(),sizes:this.getSizes(n.getAttribute(this.config.attributes.sources)),loaded:!1,options:{lazyLoad:n.getAttribute(this.config.attributes.lazyLoad)?this.parseBooleanString(n.getAttribute(this.config.attributes.lazyLoad)):this.opts.lazyLoad,lazyLoadThreshold:n.getAttribute(this.config.attributes.lazyLoadThreshold)?n.getAttribute(this.config.attributes.lazyLoadThreshold):this.opts.lazyLoadThreshold,matchDPR:n.getAttribute(this.config.attributes.matchDPR)?this.parseBooleanString(n.getAttribute(this.config.attributes.matchDPR)):this.opts.matchDPR,noHeight:!!n.getAttribute(this.config.attributes.noHeight)&&n.getAttribute(this.config.attributes.noHeight)}})}this.debugInfo(this.elementCache)}},{key:"parseBooleanString",value:function(t){return"string"==typeof t&&"true"===t.toLowerCase()||Boolean(parseInt(t))}},{key:"getContainerDimensions",value:function(t,e){var n=t.style.display?t.style.display:window.getComputedStyle(t).display,i={width:"block"==n?t.clientWidth:0,height:t.clientHeight?t.clientHeight:0};return i.width||(i.width=this.getElementWidth(t.parentElement)),e&&(i.height=0),i}},{key:"getElementWidth",value:function(t){return"block"!=(t.style.display?t.style.display:window.getComputedStyle(t).display)&&t.parentElement?this.getElementWidth(t.parentElement):t.clientWidth}},{key:"getSizes",value:function(t){return t.split(";").map(function(t){var e=t.split(","),n=_slicedToArray(e,3),i=n[0],o=n[1],a=n[2];return{url:i,width:parseInt(o),height:parseInt(a)}}).sort(function(t,e){return t.width>=t.height?t.width>e.width?1:-1:t.height>e.height?1:-1})}},{key:"calculateUsabilityScore",value:function(t,e,n,i){this.debug("container: "+t+"x"+e,"image: "+n+"x"+i);var o=1;return n>=t?o*=t/n:o-=Math.abs(t-n),e&&(i>=e?o*=e/i:o-=Math.abs(e-i)),o}},{key:"chooseImage",value:function(t){var e=this;if(!t.isLoading){t.isLoading=!0;var n=this.getSizes(t.el.getAttribute(this.config.attributes.sources)),i=t.el.tagName.toLowerCase();"img"==i&&parseInt(getComputedStyle(t.el).width)<=1&&(t.el.style.width="100%");var o=this.getContainerDimensions(t.el,t.options.noHeight);t.options.matchDPR&&(o.width*=window.devicePixelRatio,o.height*=window.devicePixelRatio);var a=n.map(function(t){return t.score=e.calculateUsabilityScore(o.width,o.height,t.width,t.height),t});a.sort(function(t,e){return t.score-e.score}),this.debugTable(a);var s=a[a.length-1];this.debug(s);var r=new Image;r.onload=function(){"img"===i?t.el.setAttribute("src",this.src):t.el.style.backgroundImage="url('"+this.src+"')",t.loaded=!0,t.isLoading=!1,window.dispatchEvent(new CustomEvent("it-imageLoad",{detail:{el:t.el}}))},r.src=s.url}}},{key:"resizeHandler",value:function(){this.debug("resizeHandler")}},{key:"scrollHandler",value:function(){for(var t=0;t<this.elementCache.length;t++){var e=this.elementCache[t];e.loaded||e.options.lazyLoad&&!this.canLazyLoad(e)||(this.debugInfo("choosing image",e),this.chooseImage(e))}}},{key:"on",value:function(t,e){"object"!==_typeof(this.events[t])&&(this.events[t]=[]),this.events[t].push(e)}},{key:"emit",value:function(t){var e,n,i,o=[].slice.call(arguments,1);if("object"===_typeof(this.events[t]))for(n=this.events[t].slice(),i=n.length,e=0;e<i;e++)n[e].apply(this,o)}}]),t}();
}());

//# sourceMappingURL=imageTools.es5.min.js.map
