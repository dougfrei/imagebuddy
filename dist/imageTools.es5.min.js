/**
 * ImageTools v0.3.1 | ISC
 * 
 */
;(function() {
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){function e(e,t){var i=[],n=!0,s=!1,o=void 0;try{for(var a,r=e[Symbol.iterator]();!(n=(a=r.next()).done)&&(i.push(a.value),!t||i.length!==t);n=!0);}catch(e){s=!0,o=e}finally{try{!n&&r.return&&r.return()}finally{if(s)throw o}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();if("function"!=typeof Object.assign&&(Object.assign=function(e,t){if(null===e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),n=1;n<arguments.length;n++){var s=arguments[n];if(null!==s)for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(i[o]=s[o])}return i}),"function"!=typeof window.CustomEvent){var _CustomEvent=function(e,t){var i=t||{bubbles:!1,cancelable:!1,detail:void 0},n=document.createEvent("CustomEvent");return n.initCustomEvent(e,i.bubbles,i.cancelable,i.detail),n};_CustomEvent.prototype=window.Event.prototype,window.CustomEvent=_CustomEvent}window.ImageTools=function(){function e(t){_classCallCheck(this,e),this.eventsRunning={},this.elementCache=[],this.elements={queue:[],loaded:[]},this.events=[],this.currentCacheId=0,this.config={events:{resize:"imageToolsResize",scroll:"imageToolsScroll"},attributes:{sources:"data-it-sources",lazyLoad:"data-it-lazyload",lazyLoadThreshold:"data-it-lazyload-threshold",matchDPR:"data-it-match-dpr",noHeight:"data-it-no-height"},classes:{base:"it__image",loading:"it__image--loading",loaded:"it__image--loaded"}},this.opts=Object.assign({debug:!1,matchDPR:!0,lazyLoad:!0,lazyLoadThreshold:100},t),this.passiveSupported=!1;try{var i=Object.defineProperty({},"passive",{get:function(){this.passiveSupported=!0}});window.addEventListener("test",null,i)}catch(e){}this.setupEventListeners(),this.update()}return _createClass(e,[{key:"processElementQueue",value:function(){if(this.elements.queue.length)for(var e=0;e<this.elements.queue.length;e++){var t=this.elements.queue[e];t.options.lazyLoad&&!1===this.canLazyLoad(t)||(this.chooseImage(t),this.elements.queue.splice(e,1),this.elements.loaded.push(t),e--)}}},{key:"update",value:function(){var e=this.getElements();this.elements.queue=this.elements.queue.concat(e),this.debugInfo(this.elements.queue),this.processElementQueue(),window.dispatchEvent(new CustomEvent("it-update",{}))}},{key:"canLazyLoad",value:function(e){return!(!e.options.lazyLoad||e.loaded)&&e.offsetTop-(window.pageYOffset+window.innerHeight)<=e.options.lazyLoadThreshold}},{key:"throttleEventListener",value:function(e,t,i){var n=this;i.passive=void 0===i.passive||i.passive,i.capture=void 0!==i.capture&&i.capture,this.eventsRunning.hasOwnProperty(e)||(this.eventsRunning[e]=!1),window.addEventListener(e,function(){n.eventsRunning[e]||(n.eventsRunning[e]=!0,requestAnimationFrame(function(){window.dispatchEvent(new CustomEvent(e+"-throttled")),n.eventsRunning[e]=!1}))},this.passiveSupported?i:i.capture),"function"==typeof t&&window.addEventListener(e+"-throttled",t,this.passiveSupported?i:i.capture)}},{key:"setupEventListeners",value:function(){this.throttleEventListener("resize",this.resizeHandler.bind(this),{passive:!0}),this.throttleEventListener("scroll",this.scrollHandler.bind(this),{passive:!0})}},{key:"debug",value:function(){if(this.opts.debug){var e;(e=console).log.apply(e,arguments)}}},{key:"debugInfo",value:function(){if(this.opts.debug){var e;(e=console).info.apply(e,arguments)}}},{key:"debugTable",value:function(){if(this.opts.debug){var e;(e=console).table.apply(e,arguments)}}},{key:"calculateElementTopOffset",value:function(e){return e.getBoundingClientRect().top+(window.pageYOffset||document.documentElement.scrollTop)}},{key:"getElements",value:function(){for(var e=[],t=document.querySelectorAll("["+this.config.attributes.sources+"]"),i=0;i<t.length;i++){var n=t[i];n.getAttribute("data-it-cache-id")||(n.setAttribute("data-it-cache-id",this.nextCacheId),n.classList.add(this.config.classes.base),e.push({el:n,elType:n.tagName.toLowerCase(),cacheId:n.getAttribute("data-it-cache-id"),offsetTop:this.calculateElementTopOffset(n),sizes:this.getSizes(n.getAttribute(this.config.attributes.sources)),currentSize:!1,loaded:!1,options:{lazyLoad:n.getAttribute(this.config.attributes.lazyLoad)?this.parseBooleanString(n.getAttribute(this.config.attributes.lazyLoad)):this.opts.lazyLoad,lazyLoadThreshold:n.getAttribute(this.config.attributes.lazyLoadThreshold)?n.getAttribute(this.config.attributes.lazyLoadThreshold):this.opts.lazyLoadThreshold,matchDPR:n.getAttribute(this.config.attributes.matchDPR)?this.parseBooleanString(n.getAttribute(this.config.attributes.matchDPR)):this.opts.matchDPR,noHeight:!!n.getAttribute(this.config.attributes.noHeight)&&n.getAttribute(this.config.attributes.noHeight)}}))}return e}},{key:"parseBooleanString",value:function(e){return"string"==typeof e&&"true"===e.toLowerCase()||Boolean(parseInt(e))}},{key:"getContainerDimensions",value:function(e,t){var i=e.style.display?e.style.display:window.getComputedStyle(e).display,n={width:"block"==i?e.clientWidth:0,height:e.clientHeight?e.clientHeight:0};return n.width||(n.width=this.getElementWidth(e.parentElement)),t&&(n.height=0),n}},{key:"getElementWidth",value:function(e){return"block"!=(e.style.display?e.style.display:window.getComputedStyle(e).display)&&e.parentElement?this.getElementWidth(e.parentElement):e.clientWidth}},{key:"getSizes",value:function(e){return e.split(",").map(function(e){var t=e.trim().split(" "),i=_slicedToArray(t,3),n=i[0],s=i[1],o=i[2];return{url:n,width:parseInt(s),height:parseInt(o)}}).sort(function(e,t){return e.width>=e.height?e.width>t.width?1:-1:e.height>t.height?1:-1})}},{key:"calculateUsabilityScore",value:function(e,t,i,n){this.debug("container: "+e+"x"+t,"image: "+i+"x"+n);var s=1;return i>=e?s*=e/i:s-=Math.abs(e-i),t&&(n>=t?s*=t/n:s-=Math.abs(t-n)),s}},{key:"chooseImage",value:function(e){var t=this;if(!e.isLoading){e.isLoading=!0;var i=this.getSizes(e.el.getAttribute(this.config.attributes.sources));"img"==e.el.tagName.toLowerCase()&&parseInt(getComputedStyle(e.el).width)<=1&&(e.el.style.width="100%");var n=this.getContainerDimensions(e.el,e.options.noHeight);e.options.matchDPR&&(n.width*=window.devicePixelRatio,n.height*=window.devicePixelRatio);var s=i.map(function(e){return e.score=t.calculateUsabilityScore(n.width,n.height,e.width,e.height),e});s.sort(function(e,t){return e.score-t.score}),this.debugTable(s);var o=s[s.length-1];this.debug(o),this.loadImage(e.el,o.url,function(){e.loaded=!0,e.isLoading=!1,e.currentSize={width:o.width,height:o.height},e.el.classList.remove(t.config.classes.loading),e.el.classList.add(t.config.classes.loaded),window.dispatchEvent(new CustomEvent("it-imageLoad",{detail:{el:e.el}}))})}}},{key:"loadImage",value:function(e,t,i){var n=new Image;n.onload=function(){"img"===e.tagName.toLowerCase()?e.setAttribute("src",this.src):e.style.backgroundImage="url('"+this.src+"')",i&&"function"==typeof i&&i()},n.src=t}},{key:"resizeHandler",value:function(){for(var e=0;e<this.elements.loaded;e++){var t=this.elements.loaded[e],i=this.getContainerDimensions(t.el);(i.width>t.currentSize.width||!t.noHeight&&i.height>t.currentSize.height)&&(this.debug("swapping image"),this.chooseImage(t))}this.processElementQueue()}},{key:"scrollHandler",value:function(){this.processElementQueue()}},{key:"on",value:function(e,t){"object"!==_typeof(this.events[e])&&(this.events[e]=[]),this.events[e].push(t)}},{key:"emit",value:function(e){var t,i,n,s=[].slice.call(arguments,1);if("object"===_typeof(this.events[e]))for(i=this.events[e].slice(),n=i.length,t=0;t<n;t++)i[t].apply(this,s)}},{key:"nextCacheId",get:function(){return this.currentCacheId=this.currentCacheId+1,this.currentCacheId}}]),e}();
}());

//# sourceMappingURL=imageTools.es5.min.js.map
