!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.imagebuddy=t()}(this,function(){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var r=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t(this,e),this.enabled=n}return i(e,[{key:"debug",value:function(){var e;this.enabled&&(e=console).log.apply(e,arguments)}},{key:"debugInfo",value:function(){var e;this.enabled&&(e=console).info.apply(e,arguments)}},{key:"debugTable",value:function(){var e;this.enabled&&(e=console).table.apply(e,arguments)}}]),e}();"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var a={},s=function(){function n(){t(this,n)}return i(n,null,[{key:"on",value:function(t,n){"object"!==e(a[t])&&(a[t]=[]),a[t].push(n)}},{key:"emit",value:function(t){for(var n=arguments,i=arguments.length,o=new Array(i>1?i-1:0),r=1;r<i;r++)o[r-1]=n[r];var s=o;setTimeout(function(){if("object"===e(a[t]))for(var n=a[t].slice(),i=0;i<n.length;i++)n[i].apply(null,s)},0)}}]),n}();function u(e){var t=e.trim().toLowerCase();return"true"===t||"false"!==t&&parseInt(t,10)>0}function l(){return void 0!==window.pageYOffset?window.pageYOffset:(document.scrollingElement||document.documentElement).scrollTop}function c(e){return e.getBoundingClientRect().top+l()}function d(e){return e.trim()?e.split(",").map(function(e){var t,n=function(e){if(Array.isArray(e))return e}(t=e.trim().split(" "))||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),3!==n.length);i=!0);}catch(e){o=!0,r=e}finally{try{i||null==s.return||s.return()}finally{if(o)throw r}}return n}}(t)||function(e,t){if(e){if("string"==typeof e)return o(e,3);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,3):void 0}}(t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),i=n[2];return{url:n[0],width:parseInt(n[1],10),height:parseInt(i,10)}}).sort(function(e,t){return e.width>=e.height?e.width>t.width?1:-1:e.height>t.height?1:-1}):[]}function h(e){return!!e&&!e.hasAttribute("data-ib-no-cache")&&!!e.getAttribute("data-ib-cache-id")}function f(e){return e.hasAttribute("data-ib-ignore")}function g(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={width:"block"===(e.style.display?e.style.display:window.getComputedStyle(e).display)?e.clientWidth:0,height:e.clientHeight?e.clientHeight:0};return!n.width&&e.parentElement&&(n.width=function e(t){return"block"!==(t.style.display?t.style.display:window.getComputedStyle(t).display)&&t.parentElement?e(t.parentElement):t.clientWidth}(e.parentElement)),t&&(n.height=0),n}var p=function(){function e(n,i,o){t(this,e),n.classList.add(i.classes.base),n.setAttribute("data-ib-cache-id",Math.random().toString(36).substring(7)),this.el=n,this.config=i,this.elType=n.tagName.toLowerCase(),this.sizes=d(n.getAttribute(i.attributes.sources)||""),this.currentSize={width:0,height:0},this.loaded=!1,this.isLoading=!1,this.options={lazyLoad:n.hasAttribute(i.attributes.lazyLoad)?u(n.getAttribute(i.attributes.lazyLoad)||""):o.lazyLoad,lazyLoadThreshold:n.hasAttribute(i.attributes.lazyLoadThreshold)?parseInt(n.getAttribute(i.attributes.lazyLoadThreshold)||"0",10):o.lazyLoadThreshold,matchDPR:n.hasAttribute(i.attributes.matchDPR)?u(n.getAttribute(i.attributes.matchDPR)||""):o.matchDPR,noHeight:!!n.hasAttribute(i.attributes.noHeight)&&u(n.getAttribute(i.attributes.noHeight)||""),ignoreHiddenCheck:!!n.hasAttribute(i.attributes.ignoreHiddenCheck)&&u(n.getAttribute(i.attributes.ignoreHiddenCheck)||"")},this.offsetTop=c(this.el)}return i(e,[{key:"updateTopOffset",value:function(){this.offsetTop=c(this.el)}},{key:"canLazyLoad",value:function(){return!(!this.options.lazyLoad||this.loaded)&&this.offsetTop-(l()+window.innerHeight)<=this.options.lazyLoadThreshold}},{key:"chooseImage",value:function(){try{var e=this;if(e.isLoading)return Promise.resolve();if(!e.options.ignoreHiddenCheck&&e.isHidden())return Promise.resolve();e.isLoading=!0;var t=d(e.el.getAttribute(e.config.attributes.sources)||"");"img"===e.el.tagName.toLowerCase()&&parseInt(getComputedStyle(e.el).width||"0",10)<=1&&(e.el.style.width="100%");var n=g(e.el,e.options.noHeight);e.options.matchDPR&&(n.width*=window.devicePixelRatio,n.height*=window.devicePixelRatio);var i=t.map(function(e){return Object.assign(e,{score:(t=n.width,i=n.height,o=e.width,r=e.height,a=1,o>=t?a*=t/o:a-=Math.abs(t-o),i&&(r>=i?a*=i/r:a-=Math.abs(i-r)),a)});var t,i,o,r,a});i.sort(function(e,t){return e.score-t.score});var o=i[i.length-1];if((a=[e.el.getAttribute("src")||"",o.url].map(function(e){var t=document.createElement("a");return t.href=e.toLowerCase(),t.host+t.pathname}))[0]===a[1])return Promise.resolve();var r=function(t,n){try{var i=Promise.resolve((r=o.url,new Promise(function(e,t){var n=new Image;n.onload=function(){e(n.src)},n.onerror=function(){t(n.src)},n.src=r}))).then(function(t){"img"===e.el.tagName.toLowerCase()?e.el.setAttribute("src",t):e.el.style.backgroundImage="url('".concat(t,"')"),e.loaded=!0,e.isLoading=!1,e.currentSize={width:o.width,height:o.height},e.el.classList.remove(e.config.classes.loading),e.el.classList.add(e.config.classes.loaded),s.emit("image-loaded",e.el)})}catch(e){return n()}var r;return i&&i.then?i.then(void 0,n):i}(0,function(){console.error("error loading image",o.url)});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}var a}},{key:"isHidden",value:function(){return null===this.el.offsetParent}}]),e}();return function(){function e(n){var i=this;t(this,e),this.resizeHandler=function(){for(var e=0;e<i.elements.loaded.length;e++){var t=i.elements.loaded[e],n=g(t.el,t.options.noHeight);(n.width>t.currentSize.width||!t.options.noHeight&&n.height>t.currentSize.height)&&(i.debugger.debug("swapping image"),t.chooseImage())}for(var o=0;o<i.elements.queue.length;o++)i.elements.queue[o].updateTopOffset();i.processElementQueue()},this.scrollHandler=function(){i.processElementQueue()},this.eventsRunning={},this.elements={queue:[],loaded:[]},this.config={events:{resize:"ImageBuddyResize",scroll:"ImageBuddyScroll"},attributes:{sources:"data-ib-sources",lazyLoad:"data-ib-lazyload",lazyLoadThreshold:"data-ib-lazyload-threshold",matchDPR:"data-ib-match-dpr",noHeight:"data-ib-no-height",ignoreHiddenCheck:"data-ib-ignore-hidden-check"},classes:{base:"ib__image",loading:"ib__image--loading",loaded:"ib__image--loaded"}},this.opts=Object.assign({debug:!1,matchDPR:!0,lazyLoad:!0,lazyLoadThreshold:100},n),this.debugger=new r(this.opts.debug),this.setupEventListeners(),this.update()}return i(e,[{key:"processElementQueue",value:function(){var e=0;if(!this.elements.queue.length)return e;for(var t=0;t<this.elements.queue.length;t++){var n=this.elements.queue[t];n.options.lazyLoad&&!1===n.canLazyLoad()||(n.chooseImage(),this.elements.queue.splice(t,1),this.elements.loaded.push(n),t--,e++)}return e}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=performance.now(),n=e.parentEl||document.documentElement,i=this.getElements(n),o=e.updateOffsetTop||!1;if(this.elements.queue=this.elements.queue.concat(i),this.debugger.debugInfo(this.elements.queue),o)for(var r=0;r<this.elements.queue.length;r++)this.elements.queue[r].updateTopOffset();var a=this.processElementQueue(),u=performance.now();this.debugger.debug("ImageBuddy: update complete","".concat(a," elements"),"".concat(Math.round(u-t),"ms")),s.emit("update")}},{key:"setupEventListeners",value:function(){this.throttleEventListener("resize",this.resizeHandler,{passive:!0}),this.throttleEventListener("scroll",this.scrollHandler,{passive:!0})}},{key:"getElements",value:function(e){for(var t=[],n=e.querySelectorAll("[".concat(this.config.attributes.sources,"]")),i=0;i<n.length;i++){var o=n[i];h(o)||f(o)||t.push(new p(o,this.config,this.opts))}return t}},{key:"throttleEventListener",value:function(e,t,n){var i=this,o=this.passiveEventListenerSupported(),r=Object.assign(n,{passive:void 0===n.passive||n.passive,capture:void 0!==n.capture&&n.capture});this.eventsRunning||(this.eventsRunning={}),Object.prototype.hasOwnProperty.call(this.eventsRunning,e)||(this.eventsRunning[e]=!1),window.addEventListener(e,function(){i.eventsRunning[e]||(i.eventsRunning[e]=!0,requestAnimationFrame(function(){window.dispatchEvent(new CustomEvent("".concat(e,"-throttled"))),i.eventsRunning[e]=!1}))},o?r:r.capture),"function"==typeof t&&window.addEventListener("".concat(e,"-throttled"),t,o?r:r.capture)}},{key:"passiveEventListenerSupported",value:function(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){return e=!0,!0}});window.addEventListener("test",function(){},t)}catch(e){}return e}}],[{key:"on",value:function(e,t){s.on(e,t)}}]),e}()});
//# sourceMappingURL=imagebuddy.umd.js.map
