class t{constructor(t=!1){this.enabled=t}debug(...t){this.enabled&&console.log(...t)}debugInfo(...t){this.enabled&&console.info(...t)}debugTable(...t){this.enabled&&console.table(...t)}}const e={};class s{static on(t,s){"object"!=typeof e[t]&&(e[t]=[]),e[t].push(s)}static emit(t,...s){const i=s;setTimeout(()=>{if("object"==typeof e[t]){const s=e[t].slice();for(let t=0;t<s.length;t++)s[t].apply(null,i)}},0)}}function i(t){const e=t.trim().toLowerCase();return"true"===e||"false"!==e&&parseInt(e,10)>0}function n(){return void 0!==window.pageYOffset?window.pageYOffset:(document.scrollingElement||document.documentElement).scrollTop}function o(t){return t.getBoundingClientRect().top+n()}function a(t){return t.trim()?t.split(",").map(t=>{const[e,s,i]=t.trim().split(" ");return{url:e,width:parseInt(s,10),height:parseInt(i,10)}}).sort((t,e)=>t.width>=t.height?t.width>e.width?1:-1:t.height>e.height?1:-1):[]}function r(t){return!!t&&!t.hasAttribute("data-ib-no-cache")&&!!t.getAttribute("data-ib-cache-id")}function h(t){return t.hasAttribute("data-ib-ignore")}function l(t,e,s,i){let n=1;return s>=t?n*=t/s:n-=Math.abs(t-s),e&&(i>=e?n*=e/i:n-=Math.abs(e-i)),n}function d(t,e=!1){const s={width:"block"===(t.style.display?t.style.display:window.getComputedStyle(t).display)?t.clientWidth:0,height:t.clientHeight?t.clientHeight:0};return!s.width&&t.parentElement&&(s.width=function t(e){return"block"!==(e.style.display?e.style.display:window.getComputedStyle(e).display)&&e.parentElement?t(e.parentElement):e.clientWidth}(t.parentElement)),e&&(s.height=0),s}class u{constructor(t,e,s){t.classList.add(e.classes.base),t.setAttribute("data-ib-cache-id",Math.random().toString(36).substring(7)),this.el=t,this.config=e,this.elType=t.tagName.toLowerCase(),this.sizes=a(t.getAttribute(e.attributes.sources)||""),this.currentSize={width:0,height:0},this.loaded=!1,this.isLoading=!1,this.options={lazyLoad:t.hasAttribute(e.attributes.lazyLoad)?i(t.getAttribute(e.attributes.lazyLoad)||""):s.lazyLoad,lazyLoadThreshold:t.hasAttribute(e.attributes.lazyLoadThreshold)?parseInt(t.getAttribute(e.attributes.lazyLoadThreshold)||"0",10):s.lazyLoadThreshold,matchDPR:t.hasAttribute(e.attributes.matchDPR)?i(t.getAttribute(e.attributes.matchDPR)||""):s.matchDPR,noHeight:!!t.hasAttribute(e.attributes.noHeight)&&i(t.getAttribute(e.attributes.noHeight)||""),ignoreHiddenCheck:!!t.hasAttribute(e.attributes.ignoreHiddenCheck)&&i(t.getAttribute(e.attributes.ignoreHiddenCheck)||"")},this.offsetTop=o(this.el)}updateTopOffset(){this.offsetTop=o(this.el)}canLazyLoad(){return!(!this.options.lazyLoad||this.loaded)&&this.offsetTop-(n()+window.innerHeight)<=this.options.lazyLoadThreshold}async chooseImage(){if(this.isLoading)return;if(!this.options.ignoreHiddenCheck&&this.isHidden())return;this.isLoading=!0;const t=a(this.el.getAttribute(this.config.attributes.sources)||"");"img"===this.el.tagName.toLowerCase()&&parseInt(getComputedStyle(this.el).width||"0",10)<=1&&(this.el.style.width="100%");const e=d(this.el,this.options.noHeight);this.options.matchDPR&&(e.width*=window.devicePixelRatio,e.height*=window.devicePixelRatio);const i=t.map(t=>Object.assign(t,{score:l(e.width,e.height,t.width,t.height)}));i.sort((t,e)=>t.score-e.score);const n=i[i.length-1];var o;if(!function(t,e){const s=[t,e].map(t=>{const e=document.createElement("a");return e.href=t.toLowerCase(),e.host+e.pathname});return s[0]===s[1]}(this.el.getAttribute("src")||"",n.url))try{const t=await(o=n.url,new Promise((t,e)=>{const s=new Image;s.onload=()=>{t(s.src)},s.onerror=()=>{e(s.src)},s.src=o}));"img"===this.el.tagName.toLowerCase()?this.el.setAttribute("src",t):this.el.style.backgroundImage=`url('${t}')`,this.loaded=!0,this.isLoading=!1,this.currentSize={width:n.width,height:n.height},this.el.classList.remove(this.config.classes.loading),this.el.classList.add(this.config.classes.loaded),s.emit("image-loaded",this.el)}catch{console.error("error loading image",n.url)}}isHidden(){return null===this.el.offsetParent}}export default class{constructor(e){this.resizeHandler=()=>{for(let t=0;t<this.elements.loaded.length;t++){const e=this.elements.loaded[t],s=d(e.el,e.options.noHeight);(s.width>e.currentSize.width||!e.options.noHeight&&s.height>e.currentSize.height)&&(this.debugger.debug("swapping image"),e.chooseImage())}for(let t=0;t<this.elements.queue.length;t++)this.elements.queue[t].updateTopOffset();this.processElementQueue()},this.scrollHandler=()=>{this.processElementQueue()},this.eventsRunning={},this.elements={queue:[],loaded:[]},this.config={events:{resize:"ImageBuddyResize",scroll:"ImageBuddyScroll"},attributes:{sources:"data-ib-sources",lazyLoad:"data-ib-lazyload",lazyLoadThreshold:"data-ib-lazyload-threshold",matchDPR:"data-ib-match-dpr",noHeight:"data-ib-no-height",ignoreHiddenCheck:"data-ib-ignore-hidden-check"},classes:{base:"ib__image",loading:"ib__image--loading",loaded:"ib__image--loaded"}},this.opts={debug:!1,matchDPR:!0,lazyLoad:!0,lazyLoadThreshold:100,...e},this.debugger=new t(this.opts.debug),this.setupEventListeners(),this.update()}processElementQueue(){let t=0;if(!this.elements.queue.length)return t;for(let e=0;e<this.elements.queue.length;e++){const s=this.elements.queue[e];s.options.lazyLoad&&!1===s.canLazyLoad()||(s.chooseImage(),this.elements.queue.splice(e,1),this.elements.loaded.push(s),e--,t++)}return t}update(t={}){const e=performance.now(),i=t.parentEl||document.documentElement,n=this.getElements(i),o=t.updateOffsetTop||!1;if(this.elements.queue=this.elements.queue.concat(n),this.debugger.debugInfo(this.elements.queue),o)for(let t=0;t<this.elements.queue.length;t++)this.elements.queue[t].updateTopOffset();const a=this.processElementQueue(),r=performance.now();this.debugger.debug("ImageBuddy: update complete",a+" elements",Math.round(r-e)+"ms"),s.emit("update")}setupEventListeners(){this.throttleEventListener("resize",this.resizeHandler,{passive:!0}),this.throttleEventListener("scroll",this.scrollHandler,{passive:!0})}getElements(t){const e=[],s=t.querySelectorAll(`[${this.config.attributes.sources}]`);for(let t=0;t<s.length;t++){const i=s[t];r(i)||h(i)||e.push(new u(i,this.config,this.opts))}return e}throttleEventListener(t,e,s){const i=this.passiveEventListenerSupported(),n=Object.assign(s,{passive:void 0===s.passive||s.passive,capture:void 0!==s.capture&&s.capture});this.eventsRunning||(this.eventsRunning={}),Object.prototype.hasOwnProperty.call(this.eventsRunning,t)||(this.eventsRunning[t]=!1),window.addEventListener(t,()=>{this.eventsRunning[t]||(this.eventsRunning[t]=!0,requestAnimationFrame(()=>{window.dispatchEvent(new CustomEvent(t+"-throttled")),this.eventsRunning[t]=!1}))},i?n:n.capture),"function"==typeof e&&window.addEventListener(t+"-throttled",e,i?n:n.capture)}passiveEventListenerSupported(){let t=!1;try{const e=Object.defineProperty({},"passive",{get:()=>(t=!0,!0)});window.addEventListener("test",()=>{},e)}catch(t){}return t}static on(t,e){s.on(t,e)}}
//# sourceMappingURL=imagebuddy.modern.js.map
